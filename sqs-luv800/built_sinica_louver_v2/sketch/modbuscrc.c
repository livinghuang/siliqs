#line 1 "/Users/living/code/github/siliqs/sqs-luv800/sinica_louver_v2/modbuscrc.c"
#include <stdint.h>
#include <stdio.h>
uint8_t recieved[] = {0x01, 0x21, 0x25, 0x50, 0xE3, 0xB6, 0x6E, 0x9E, 0x9C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x06, 0x94, 0x02, 0xE0, 0x6B, 0x90, 0x43, 0x68, 0xB2, 0xEB, 0x41, 0x33, 0xD4, 0xC4, 0x47, 0x02}; //, 0x8F, 0x4A};

uint16_t modbusCRC(uint8_t *buffer, int len)
{
  uint16_t crc = 0xFFFF;
  for (int pos = 0; pos < len; pos++)
  {
    crc ^= (uint16_t)buffer[pos];
    for (int i = 8; i > 0; i--)
    { // 使用 > 保证循环次数明确
      if ((crc & 0x0001) != 0)
      {
        crc >>= 1;
        crc ^= 0xA001;
      }
      else
      {
        crc >>= 1;
      }
    }
  }
  return crc;
}

int main()
{
  // 示例数据
  // uint8_t data[] = {0x01, 0x03, 0x14, 0x90, 0x3C, 0x09, 0x42, 0xF4, 0xB0, 0xC5, 0x47, 0xAF, 0x0B, 0x02, 0x00, 0x09, 0x00, 0x14, 0x01, 0x20, 0x02, 0x00, 0x00};
  // uint8_t data[] = {0x42, 0x4D, 0x00, 0x08, 0x06, 0x18, 0x00, 0x00, 0x0D, 0x10, 0x00, 0xD2};
  uint8_t data[] = {0x42, 0x4D, 0x00, 0x08, 0x06, 0xDD, 0x00, 0x00, 0x0D, 0x73, 0x01, 0xFA};
  // 42 4D 00 08 06 DD 00 00 0D 73 01 FA  // D4 49 0A 3C 48 E9 C8 3F
  int length = sizeof(data) / sizeof(data[0]);

  uint16_t crc = modbusCRC(data, length);

  printf("CRC: %04X\n", crc);
}
